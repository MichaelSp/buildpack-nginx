#!/usr/bin/env bash

set -e
set -o pipefail

BUILD_DIR=$1
CUR_DIR=`cd $(dirname $0); cd ..; pwd`

try_install() {
    dpkg -l "$1" | grep -q ^ii && return 1
    apt-get update
    apt-get -y install "$@"
    return 0
}

try_install nginx

# build nginx config unless overridden by user
if [ ! -f $BUILD_DIR/nginx/nginx.conf ] ; then
  echo "-----> using default nginx.conf.erb"
  cp conf/nginx.conf.erb $BUILD_DIR/nginx/nginx.conf.erb
fi

# build mime.types unless overridden by user
if [ ! -f $BUILD_DIR/mime.types ] ; then
  echo "-----> using default mime.types"
  cp conf/mime.types $BUILD_DIR/nginx/mime.types
fi

# build a startup script
cat <<EOF >"$BUILD_DIR/start_nginx"
#!/usr/bin/env bash
rm -f /app/nginx/nginx.conf
erb /app/nginx/nginx.conf.erb > /app/nginx/nginx.conf
exec nginx -p /app/nginx -c /app/nginx/nginx.conf
EOF
chmod +x "$BUILD_DIR/start_nginx"
